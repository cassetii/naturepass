<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrasi Kawasan Hutan Pinuslo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #334d2b;
            --secondary-color: #8d9882;
            --accent-color: #7ea230;
            --light-bg: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--light-bg) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(51, 77, 43, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }

        .card-title {
            margin: 0;
            font-weight: 600;
            text-align: center;
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(126, 162, 48, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(51, 77, 43, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .total-display {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
        }

        .spinner-border {
            color: var(--accent-color);
        }

        .alert {
            border: none;
            border-radius: 10px;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ticket-number {
            background: var(--light-bg);
            border: 2px dashed var(--accent-color);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--primary-color);
        }

        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem;
        }

        .table tbody tr:hover {
            background: rgba(126, 162, 48, 0.1);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-mountain me-2"></i>
                            Registrasi Kawasan Hutan Pinuslo
                        </h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Form Registrasi -->
            <div class="col-lg-8">
                <div class="card slide-in">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-edit me-2"></i>
                            Form Registrasi
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="registrationForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="petugasLoket" class="form-label">
                                        <i class="fas fa-user me-2"></i>Nama Petugas Loket
                                    </label>
                                    <input type="text" class="form-control" id="petugasLoket" placeholder="Masukkan nama petugas" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tanggal" class="form-label">
                                        <i class="fas fa-calendar me-2"></i>Tanggal Hari
                                    </label>
                                    <input type="date" class="form-control" id="tanggal" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="jumlahOrang" class="form-label">
                                        <i class="fas fa-users me-2"></i>Jumlah Orang
                                    </label>
                                    <input type="number" class="form-control" id="jumlahOrang" min="1" placeholder="1" value="1" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="jenisKunjungan" class="form-label">
                                        <i class="fas fa-list me-2"></i>Jenis Kunjungan
                                    </label>
                                    <select class="form-select" id="jenisKunjungan" required>
                                        <option value="">Pilih jenis kunjungan</option>
                                        <option value="cafe" data-price="10000">Kunjungan Cafe - Rp 10.000</option>
                                        <option value="weekday" data-price="15000">Kunjungan Menginap Weekday - Rp 15.000</option>
                                        <option value="weekend" data-price="20000">Kunjungan Menginap Weekend - Rp 20.000</option>
                                        <option value="hiking" data-price="50000">Paket Hiking - Rp 50.000</option>
                                    </select>
                                </div>
                            </div>

                            <div class="ticket-number" id="ticketNumber">
                                <i class="fas fa-ticket-alt me-2"></i>
                                Nomor Tiket: <span id="ticketDisplay">-</span>
                            </div>

                            <div class="total-display pulse">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                Total: Rp <span id="totalAmount">0</span>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary me-md-2" onclick="loadData()">
                                    <i class="fas fa-sync-alt me-2"></i>Load Data
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Simpan Registrasi
                                </button>
                            </div>
                        </form>

                        <div class="loading" id="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Menyimpan data...</p>
                        </div>

                        <div id="alertContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Data List -->
            <div class="col-lg-4">
                <div class="card fade-in">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-list me-2"></i>
                            Data Registrasi
                        </h4>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="dataList">
                            <p class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Belum ada data registrasi
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, orderBy, query } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGTPNboLMi7zv1m1zSlmZk4or0TR1F6sg",
            authDomain: "registrasipinusselowbissoloro.firebaseapp.com",
            projectId: "registrasipinusselowbissoloro",
            storageBucket: "registrasipinusselowbissoloro.firebasestorage.app",
            messagingSenderId: "185801761825",
            appId: "1:185801761825:web:bc262bb3b2769e964fef60",
            measurementId: "G-1LVJ83FFP6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make functions globally available
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.query = query;
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let registrationCounter = 1;
        
        // Set tanggal hari ini sebagai default
        document.getElementById('tanggal').valueAsDate = new Date();
        
        // Generate nomor tiket otomatis
        function generateTicketNumber() {
            const date = new Date(document.getElementById('tanggal').value);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const regNumber = String(registrationCounter).padStart(4, '0');
            
            return `PIN-${day}${month}${year}-${regNumber}`;
        }
        
        // Update nomor tiket saat tanggal berubah
        document.getElementById('tanggal').addEventListener('change', function() {
            updateTicketNumber();
        });
        
        function updateTicketNumber() {
            const ticketNumber = generateTicketNumber();
            document.getElementById('ticketDisplay').textContent = ticketNumber;
        }
        
        // Update total saat input berubah
        function updateTotal() {
            const jumlahOrang = parseInt(document.getElementById('jumlahOrang').value) || 0;
            const jenisSelect = document.getElementById('jenisKunjungan');
            const selectedOption = jenisSelect.options[jenisSelect.selectedIndex];
            const price = parseInt(selectedOption.getAttribute('data-price')) || 0;
            
            const total = jumlahOrang * price;
            document.getElementById('totalAmount').textContent = total.toLocaleString('id-ID');
        }
        
        document.getElementById('jumlahOrang').addEventListener('input', updateTotal);
        document.getElementById('jenisKunjungan').addEventListener('change', updateTotal);
        
        // Tampilkan alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Submit form
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                const formData = {
                    petugasLoket: document.getElementById('petugasLoket').value,
                    nomorTiket: document.getElementById('ticketDisplay').textContent,
                    tanggal: document.getElementById('tanggal').value,
                    jumlahOrang: parseInt(document.getElementById('jumlahOrang').value),
                    jenisKunjungan: document.getElementById('jenisKunjungan').options[document.getElementById('jenisKunjungan').selectedIndex].text,
                    total: parseInt(document.getElementById('totalAmount').textContent.replace(/\./g, '')),
                    timestamp: new Date()
                };
                
                await window.addDoc(window.collection(window.db, 'registrasi'), formData);
                
                showAlert('Data berhasil disimpan!', 'success');
                
                // Reset form
                document.getElementById('registrationForm').reset();
                document.getElementById('tanggal').valueAsDate = new Date();
                registrationCounter++;
                updateTicketNumber();
                updateTotal();
                
                // Load data terbaru
                loadData();
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Gagal menyimpan data. Pastikan Firebase rules sudah dikonfigurasi dengan benar.', 'danger');
            } finally {
                loading.style.display = 'none';
            }
        });
        
        // Load data dari Firebase
        async function loadData() {
            try {
                const q = window.query(window.collection(window.db, 'registrasi'), window.orderBy('timestamp', 'desc'));
                const querySnapshot = await window.getDocs(q);
                
                const dataList = document.getElementById('dataList');
                
                if (querySnapshot.empty) {
                    dataList.innerHTML = `
                        <p class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Belum ada data registrasi
                        </p>
                    `;
                    return;
                }
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = new Date(data.timestamp.seconds * 1000);
                    
                    html += `
                        <div class="card mb-2 fade-in">
                            <div class="card-body p-3">
                                <h6 class="card-title text-primary">${data.nomorTiket}</h6>
                                <p class="card-text small mb-1">
                                    <strong>Petugas:</strong> ${data.petugasLoket}<br>
                                    <strong>Tanggal:</strong> ${data.tanggal}<br>
                                    <strong>Jumlah:</strong> ${data.jumlahOrang} orang<br>
                                    <strong>Jenis:</strong> ${data.jenisKunjungan}<br>
                                    <strong>Total:</strong> Rp ${data.total.toLocaleString('id-ID')}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${date.toLocaleString('id-ID')}
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                dataList.innerHTML = html;
                
                // Update counter berdasarkan data terakhir
                if (!querySnapshot.empty) {
                    registrationCounter = querySnapshot.size + 1;
                    updateTicketNumber();
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Gagal memuat data. Pastikan Firebase rules sudah dikonfigurasi dengan benar.', 'warning');
            }
        }
        
        // Make loadData globally available
        window.loadData = loadData;
        
        // Initialize
        updateTicketNumber();
        updateTotal();
        loadData();
    </script>
</body>
</html>
